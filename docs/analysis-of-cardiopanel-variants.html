<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Week 3 Analysis of Cardiopanel Variants | Case background information and exercises</title>
<meta name="author" content="Marcel Kempenaar and Ronald Wedema">
<meta name="description" content="Once we are done with mapping all reads to the reference genome, we can determine the variant positions within the genes of interest. For this we use a Galaxy tool called LoFreq that will report...">
<meta name="generator" content="bookdown 0.35 with bs4_book()">
<meta property="og:title" content="Week 3 Analysis of Cardiopanel Variants | Case background information and exercises">
<meta property="og:type" content="book">
<meta property="og:description" content="Once we are done with mapping all reads to the reference genome, we can determine the variant positions within the genes of interest. For this we use a Galaxy tool called LoFreq that will report...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Week 3 Analysis of Cardiopanel Variants | Case background information and exercises">
<meta name="twitter:description" content="Once we are done with mapping all reads to the reference genome, we can determine the variant positions within the genes of interest. For this we use a Galaxy tool called LoFreq that will report...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.5.1/transition.js"></script><script src="libs/bs3compat-0.5.1/tabs.js"></script><script src="libs/bs3compat-0.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Case background information and exercises</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">About</a></li>
<li><a class="" href="intro-ngs-and-genetics-project.html"><span class="header-section-number">1</span> Intro NGS and Genetics Project</a></li>
<li><a class="" href="read-mapping.html"><span class="header-section-number">2</span> Read Mapping</a></li>
<li><a class="active" href="analysis-of-cardiopanel-variants.html"><span class="header-section-number">3</span> Analysis of Cardiopanel Variants</a></li>
<li><a class="" href="variant-annotation.html"><span class="header-section-number">4</span> Variant Annotation</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/rwedema/NGS-Genetics/">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="analysis-of-cardiopanel-variants" class="section level1" number="3">
<h1>
<span class="header-section-number">Week 3</span> Analysis of Cardiopanel Variants<a class="anchor" aria-label="anchor" href="#analysis-of-cardiopanel-variants"><i class="fas fa-link"></i></a>
</h1>
<p>Once we are done with mapping all reads to the reference genome, we can determine the variant positions within the genes of interest. For this we use a Galaxy tool called <em>LoFreq</em> that will report on found variants and their statistics such as allele frequency, number of supported reads, average base quality at the found position, etc.</p>
<p>Before finding the actual variants, we will perform analysis assessing the achieved coverage. As you might have seen in IGV, coverages range from very high numbers (300+) to places where there are only a few reads present. In this chapter we will use R with a number of libraries often used for genetics research to report on these numbers for all cardiopanel genes.</p>
<div id="assignment-week-3" class="section level2" number="3.1">
<h2>
<span class="header-section-number">3.1</span> Assignment week 3<a class="anchor" aria-label="anchor" href="#assignment-week-3"><i class="fas fa-link"></i></a>
</h2>
<div id="programming-assignments-coverage-overview-for-cardiopanel-genes" class="section level3" number="3.1.1">
<h3>
<span class="header-section-number">3.1.1</span> Programming Assignments; Coverage Overview for Cardiopanel Genes<a class="anchor" aria-label="anchor" href="#programming-assignments-coverage-overview-for-cardiopanel-genes"><i class="fas fa-link"></i></a>
</h3>
<p>Within the output of the previous mapping step (the BAM file) we can see how (well) our
panel-genes are covered by our reads, a very important statistic on the
quality of our data. We could assess this manually using IGV, but that is definitely not the method to use for such a task even though there are ‘only’ about 50 genes in total. This section contains a number of small assignments that - once completed - will give us a clear indication whether our mapping is of sufficient quality. Depending on this outcome we might need to revisit our previous step(s) such as the trimming process to increase our mapping quality.</p>
<p>During these assignments we will gain insight into the coverage of all of our genes of interest as well as their variants. We will use the BED-file describing the locations of all exons, the BAM file containing the mapped reads and - which we’ll create later - a VCF-file listing all found variants. A number of assignments asks to visualize the results to get a good understanding of what we’re looking at.</p>
</div>
<div id="assignment-instructions" class="section level3" number="3.1.2">
<h3>
<span class="header-section-number">3.1.2</span> Assignment Instructions<a class="anchor" aria-label="anchor" href="#assignment-instructions"><i class="fas fa-link"></i></a>
</h3>
<p>Below are a number assignments that together perform the tasks as
explained above. For each you are required to <strong>carefully read the
instructions</strong> and make sure you understand the goal and data used for
that particular assignment. Being able to <strong>critically reflect</strong> on the
outcome of your analysis is the most important aspect of being a
bioinformatician! Furthermore, these assignments are generally a
guideline and while it should be considered the minimum tasks to
complete, you are always invited to do <em>more</em> with the data that you
have. Feel free to explore and keep that code in your lab-journal as
well.</p>
<p>To perform some of these tasks we do need to learn some theory that is
specific for working with our data (BED and Pileup files among others).
For that we will introduce the Bioconductor libraries later on. First
though we will explore the most simple of our data files and create a
few simple plots based on the BED data.</p>
<p>For each of these assignments, create at least one code-chunk, name it
accordingly and in between the assignments reflect on what you did. For
instance as the end product of assignment one is a dataframe with a
proper header and an overview plot of the number of exons per
chromosome, you could end this assignment by stating <em>“After loading and processing the data, the overview shows all chromosomes on which exons are located for the opanel genes”</em>.</p>
</div>
<div id="assignment-1-loading-the-bed-data" class="section level3" number="3.1.3">
<h3>
<span class="header-section-number">3.1.3</span> Assignment 1; Loading the BED-data<a class="anchor" aria-label="anchor" href="#assignment-1-loading-the-bed-data"><i class="fas fa-link"></i></a>
</h3>
<p>The first step of our program is to read the BED file to get the exon
locations for our opanel genes. We already viewed the contents of the
BED file in Galaxy, where we saw that this file contains 4 columns:</p>
<ul>
<li>The chromosome number,</li>
<li>exon start location,</li>
<li>exon end location and the</li>
<li>gene name</li>
</ul>
<p>For example:</p>
<pre><code>10  75399683    75399795    MYOZ1   
10  75757946    75758153    VCL   
10  75802821    75802931    VCL</code></pre>
<p>Perform these tasks:</p>
<ol style="list-style-type: decimal">
<li>Load the BED-data
<ul>
<li>Since this data is stored in a text file using tabs as column
separators, we can easily read this in using the <code>read.table</code>
function.</li>
</ul>
</li>
<li>Change the column names
<ul>
<li>There are no column names in the BED-file and <code>read.table</code> gives
default names in this case: <code>[1] "V1" "V2" "V3" "V4"</code>. Using the
<code>names</code> function, we can assign new column names, do this by
assigning a vector with four column names (see the help of
<code>names</code>)</li>
</ul>
</li>
<li>Print the number of exons per chromosome
<ul>
<li>An easy way to get an overview of large amounts of data (only
1204 exons in this case) is by using the <code>table</code> function. Using
this function, show the number of exons per chromosome.</li>
</ul>
</li>
<li>Plot the number of exons per chromosome
<ul>
<li>The data from (3) can be used to create a plot by giving it to
the <code>barplot</code> function. Change the label on the y-axis to
something meaningful. Since the chromosome numbers can’t all fit
on the x-axis you can change its orientation using the <code>las = 2</code>
argument to <code>barplot</code>. Further options aren’t necessary and the
plot doesn’t have to be very pretty at this stage.</li>
</ul>
</li>
</ol>
</div>
<div id="assignment-2-bed-visualization" class="section level3" number="3.1.4">
<h3>
<span class="header-section-number">3.1.4</span> Assignment 2; BED-visualization<a class="anchor" aria-label="anchor" href="#assignment-2-bed-visualization"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>Visualize the number of genes per chromosome
<ul>
<li>This requires the creation of a subset of unique chromosome-gene
combinations; all genes consist of exons but if we reduce all
genes to a single exon (doesn’t matter which), we can then use
the <code>table</code> function again to give us the numbers that we need.</li>
<li>Select only the ‘chromosome’ and ‘gene’ columns (using the names
that you gave in assignment 1.2) from the BED-data</li>
<li>Apply the <code>unique</code> function to reduce this data to a single row
per gene and store only the ‘chromosome’ column of the result</li>
<li>Give this data to <code>table</code> and use that result as input for the
<code>barplot</code> function using a proper label for the y-axis.</li>
</ul>
</li>
</ol>
</div>
<div id="assignment-3-bioconductor" class="section level3" number="3.1.5">
<h3>
<span class="header-section-number">3.1.5</span> Assignment 3; Bioconductor<a class="anchor" aria-label="anchor" href="#assignment-3-bioconductor"><i class="fas fa-link"></i></a>
</h3>
<p>As software developers develop algorithms or solutions for common
problems, they would like to publish their code so that others can use
it too. For R (and many other programming languages) this code is
packaged in a <em>library</em> that can then be easily distributed to others.
You might already be familiar with the <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> function in R to load
external code into your environment and that is what we will do here
too.</p>
<p><a href="http://bioconductor.org">Bioconductor</a> is a <em>repository</em> that contains
over 1800 of these libraries that we can get into R and use to perform
analysis with. This vast amount of libraries are all focused on
analyzing, processing and visualizing (high-throughput) biological data
which we will also be using during both practical courses. Luckily you
don’t have to find the libraries yourself and the assignments will
always instruct on which one to use (to load actually, since they are
pre-installed on our network).</p>
<p>What we will introduce here is a concept that is required for most of
the remaining assignments below, namely <code>GenomicRanges</code> objects
(<a href="http://bioconductor.org/packages/release/bioc/html/GenomicRanges.html">website</a>,
<a href="http://bioconductor.org/packages/release/bioc/vignettes/GenomicRanges/inst/doc/GenomicRangesIntroduction.html">manual</a>),
consisting of <code>IRanges</code>
(<a href="http://bioconductor.org/packages/release/bioc/html/IRanges.html">website</a>,
<a href="http://bioconductor.org/packages/release/bioc/vignettes/IRanges/inst/doc/IRangesOverview.pdf">manual</a>)
objects. These ‘<em>objects</em>’ (they hold data in a combination of vectors,
lists and data frames among other data structures) are used to store
information about features on the genome. These features (introns,
exons, variants, etc.) are always defined by their coordinates such as
start and stop positions and the name of the sequence (in our case,
chromosome) on which they lie.</p>
<p>The BED-file for instance can be represented using
<code>IRanges</code> since it contain simple positional data (chromosome
and position (start/ stop for BED-data). Let’s first see an example of representing a few exons from the BED file into <code>IRanges</code> objects (you don’t need to replicate this
example).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Only needed when the package is missing</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://bioconductor.github.io/BiocManager/">"BiocManager"</a></span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://bioconductor.github.io/BiocManager/reference/install.html">install</a></span><span class="op">(</span><span class="st">"GenomicRanges"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This package contains the 'IRanges', 'GRanges' and 'GRangesList' classes we will use</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/GenomicRanges">GenomicRanges</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Loading the BED data (note: use your own data from assignment 1)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data/bed_data.RData"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Print all rows where the gene name is for example 'SOD2'</span></span>
<span><span class="va">bed_file</span><span class="op">[</span><span class="va">bed_file</span><span class="op">$</span><span class="va">gene</span> <span class="op">==</span> <span class="st">"SOD2"</span>, <span class="op">]</span></span></code></pre></div>
<pre><code>##     chromosome     begin       end gene
## 649          6 160103505 160103690 SOD2
## 650          6 160105866 160106085 SOD2
## 651          6 160109138 160109294 SOD2
## 652          6 160113673 160113915 SOD2
## 653          6 160114157 160114219 SOD2</code></pre>
<p>Shown above is a dataframe similar to your data containing the five
exons of the <code>SOD2</code> gene located on chromosome 6. For each exon we have
a begin and end coordinate. This data can be converted into <code>IRanges</code> by
using the similar named function and providing the correct columns as
shown below:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the data as a subset of the cardiopanel data</span></span>
<span><span class="va">sod2</span> <span class="op">&lt;-</span> <span class="va">bed_file</span><span class="op">[</span><span class="va">bed_file</span><span class="op">$</span><span class="va">gene</span> <span class="op">==</span> <span class="st">"SOD2"</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Assign whole columns to the IRanges arguments</span></span>
<span><span class="va">ranges</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/IRanges-constructor.html">IRanges</a></span><span class="op">(</span>start <span class="op">=</span> <span class="va">sod2</span><span class="op">$</span><span class="va">begin</span>,</span>
<span>                  end <span class="op">=</span> <span class="va">sod2</span><span class="op">$</span><span class="va">end</span>,</span>
<span>                  names <span class="op">=</span> <span class="va">sod2</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span></span>
<span><span class="co"># Print the object</span></span>
<span><span class="va">ranges</span></span></code></pre></div>
<pre><code>## IRanges object with 5 ranges and 0 metadata columns:
##            start       end     width
##        &lt;integer&gt; &lt;integer&gt; &lt;integer&gt;
##   SOD2 160103505 160103690       186
##   SOD2 160105866 160106085       220
##   SOD2 160109138 160109294       157
##   SOD2 160113673 160113915       243
##   SOD2 160114157 160114219        63</code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate and print the length of a gene</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Length of SOD2:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/start.html">width</a></span><span class="op">(</span><span class="va">ranges</span><span class="op">)</span> <span class="op">)</span>, <span class="st">"bp"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Length of SOD2: 869 bp</code></pre>
<p>We see the same data now represented as an <code>IRanges</code> object. We do however both miss some data (the chromosome) and get some extra data as well (the <em>width</em> (length) of each exon). As it’s important to know on which chromosome each gene lies we will convert our <code>ranges</code> object into a <code>GRanges</code> object that combines both data:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Converts to GRanges and adds the text 'chr' to each chromosome</span></span>
<span><span class="va">granges</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/GenomicRanges/man/GRanges-class.html">GRanges</a></span><span class="op">(</span>seqnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"chr"</span>, <span class="va">sod2</span><span class="op">$</span><span class="va">chromosome</span><span class="op">)</span>,</span>
<span>                   ranges <span class="op">=</span> <span class="va">ranges</span><span class="op">)</span></span>
<span><span class="va">granges</span></span></code></pre></div>
<pre><code>## GRanges object with 5 ranges and 0 metadata columns:
##        seqnames              ranges strand
##           &lt;Rle&gt;           &lt;IRanges&gt;  &lt;Rle&gt;
##   SOD2     chr6 160103505-160103690      *
##   SOD2     chr6 160105866-160106085      *
##   SOD2     chr6 160109138-160109294      *
##   SOD2     chr6 160113673-160113915      *
##   SOD2     chr6 160114157-160114219      *
##   -------
##   seqinfo: 1 sequence from an unspecified genome; no seqlengths</code></pre>
<p>When comparing the <code>IRanges</code> object with the <code>GRanges</code> object, it looks rather similar with yet again some missing data (the <em>width</em>) and some extra data (the <em>strand</em>). Nothing is lost though, as objects often have a lot of <em>accessor</em> methods that you can use for getting to the actual data, as the example above is a <em>representation</em> of the object that you get when you print it. Functions such as <code><a href="https://rdrr.io/pkg/BiocGenerics/man/start.html">width()</a></code> applied to an <code>IRanges</code> object gives the <code>width</code> column and the <code><a href="https://rdrr.io/pkg/IRanges/man/range-squeezers.html">ranges()</a></code> function applied to a <code>GRanges</code> object gives the <code>IRanges</code> object contained within. When needed, the assignments will hint to their usage but the linked manuals also describe the most important ones.</p>
<p>Now that we have a gene within a <code>GRanges</code> object, what can we do with it? For now with just the BED data not a lot, but as we will also put the Pileup data into a similar <code>GRanges</code> object, we can start asking our data interesting questions with the <code>pileup</code> function for instance. This can be used to get the Pileup information specific for our exons and ignoring everything else. But before we can do that we need to get our BED-data into the proper format first and that is what we will do now.</p>
<p>This more challenging assignment results in yet another type of object, named a <code>GRangesList</code> that contains multiple <code>GRanges</code> objects; one for each gene such as shown in the above example. So, in order to do that we need to:</p>
<ol style="list-style-type: decimal">
<li>Create an empty (standard) R list,</li>
<li>Iterate over all of our genes in the BED file,
<ul>
<li>Read the part about <code>iteration</code> below and</li>
<li>the hints about the <code>split</code> function to get the gene names and data easily accessible.</li>
</ul>
</li>
<li>For each gene, create a <code>GRanges</code> object and add it to the list, including the gene name (use the following form: <code>my_list[[gene_name]] &lt;- data</code>) and</li>
<li>
<em>Convert</em> the complete list into a <code>GRangesList</code> object.
<ul>
<li>Use the conversion as explained in the <code>GRanges</code> manual: <code>bed_data &lt;- GRangesList(bed_data)</code> given that the list is called <code>bed_data</code>.</li>
</ul>
</li>
</ol>
<p>The techniques required for this assignment are mainly knowing how to work with lists (including how to create them, accessing single elements, adding to lists and iterating over its items). The following hints, the numbered list above and the examples are everything you need to do this assignment. Below is a bit of code to show the expected result which you can repeat on your own data as a check.</p>
<p><strong>Hints and further instructions:</strong></p>
<p><strong>Iteration</strong></p>
<p>When we talk about iterating when performing programming, we mean repeatedly performing a set of operations on separate elements (of a vector, a list, columns or rows of a data-frame, etc.). In ordinary programming languages this often requires explicit step-wise execution of these operations, using constructs such as <code>for</code> and <code>while</code> ‘loops’. In R however, we already perform a lot of iterative steps without realizing it. Given a vector <code>x</code>, we can multiply each value with itself by simply stating <code>x * x</code>. Programming languages such as Python, Java and C require code like:</p>
<pre><code>squared = []
for value in x:
    squared.append(value * value)</code></pre>
<p>This is still pretty readable code, but in R we never require this explicit form even though we <em>could</em>. This simple one liner in R for instance calculates the average log2 ratio of two columns from a data-frame that can contain thousands of rows and many columns, at once:</p>
<pre><code>mean(log2(dat['sample1], dat['sample2']))</code></pre>
<p>which would require a rather large for-loop in most other languages. When we do want to apply something to each element separately in R we often use - rather complicated but efficient - <code>apply</code> functions. For now though we will use the easier to understand <code>for</code> loop to perform our code on data for each gene (point 1 above). With the following example on iterating over our bed_data you should be able to perform this assignment:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the stored data; do not repeat. Object name in this</span></span>
<span><span class="co"># example is 'bed_data' </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">'data/bed_data_GRangesList.RData'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split the data by gene, resulting in a list with named elements</span></span>
<span><span class="va">bed_splitted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/splitAsList.html">split</a></span><span class="op">(</span><span class="va">bed_file</span>, <span class="va">bed_file</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span></span>
<span><span class="co"># Print the names of the first 10 genes</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">gene</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">bed_splitted</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">gene</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code>## [1] "ABCC9"
## [1] "ACTC1"
## [1] "ACTN2"
## [1] "ANKRD1"
## [1] "BAG3"
## [1] "CALR3"
## [1] "CAV3"
## [1] "CRYAB"
## [1] "CSRP3"
## [1] "DES"</code></pre>
<p><strong>Hints</strong></p>
<ul>
<li>As point 2 asks to iterate over all genes, we need to think of a way to group our data (exons) into genes which can be done using the <code>split</code> function. The result of <code>split</code> is a list with 55 named elements; one for each gene.
<ul>
<li>The <code>split</code> function requires two arguments: first the data-frame containing all of the data and the second argument is the column containing the gene names (i.e. <code>bed_file$gene</code>)</li>
<li>You can get the gene names by executing the <code>names</code> function on the resulting list from <code>split</code>.</li>
<li>You can get all the exon-rows easily by accessing the list items: <code>split_output[[gene_name]]</code>.</li>
</ul>
</li>
<li>When iterating, the code that you execute for each gene could be (1) create an <code>IRanges</code> object, (2) create a <code>GRanges</code> object combining the chromosome with the <code>IRanges</code> object and finally appending this to a list.</li>
</ul>
<p>Once completed, you should run the following code - besides the <code>load</code> function - and compare the results. Also, this was most likely a very challenging assignment but we will re-use parts of the code you have made now. Revisit everything you’ve written to complete this task and make sure you understand what everything does (the exact <em>how</em> it works is of less importance).</p>
</div>
<div id="assignment-4-gene-lengths" class="section level3" number="3.1.6">
<h3>
<span class="header-section-number">3.1.6</span> Assignment 4; Gene Lengths<a class="anchor" aria-label="anchor" href="#assignment-4-gene-lengths"><i class="fas fa-link"></i></a>
</h3>
<p>We’ll create one last visualization based on the BED-data - but now using the <code>GRanges</code> object - namely an overview of the gene lengths; another barplot. The example code above shows how to calculate the length of a single gene (using <code>ranges</code>, <code>width</code> and <code>sum</code>). The same code also works on the complete <code>GRangesList</code> object, use this to create a barplot showing the length of each gene.</p>
<p><strong>Hint:</strong></p>
<p>As you will notice, there is one gene that is very long compared to the others and this makes the plot difficult to read. The <code>plotrix</code> library contains the <code>gap.barplot</code> function specifically for this purpose (also supports the <code>las = 2</code> argument). Try to use this function for creating the barplot. As a small challenge you can try to style the y-axis to show more values (‘ticks’) besides the minimum and maximum.</p>
</div>
<div id="assignment-5-loading-the-mapped-reads" class="section level3" number="3.1.7">
<h3>
<span class="header-section-number">3.1.7</span> Assignment 5; Loading the Mapped Reads<a class="anchor" aria-label="anchor" href="#assignment-5-loading-the-mapped-reads"><i class="fas fa-link"></i></a>
</h3>
<p>In R we will use the output of the <em>mapping</em> step (the BAM file) to inspect the coverage of all mapped positions of our panel genes. There is an R library that can read this data (<code>RSamtools</code> <a href="https://bioconductor.org/packages/release/bioc/html/Rsamtools.html">website</a> and <a href="https://bioconductor.org/packages/release/bioc/vignettes/Rsamtools/inst/doc/Rsamtools-Overview.pdf">manual</a>) into <code>GRanges</code> objects. We have already downloaded the data as it was the input for the IGV tool in the previous chapter.</p>
</div>
<div id="rsamtools" class="section level3" number="3.1.8">
<h3>
<span class="header-section-number">3.1.8</span> Rsamtools<a class="anchor" aria-label="anchor" href="#rsamtools"><i class="fas fa-link"></i></a>
</h3>
<p>Again, we have to briefly introduce this library before you will be able to use it. Rsamtools is described as “<em>an interface to BAM files</em>”, the file that contains all the mapping information.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Installing required library</span></span>
<span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://bioconductor.github.io/BiocManager/reference/install.html">install</a></span><span class="op">(</span><span class="st">"Rsamtools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loading the RSamtools library</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/Rsamtools">Rsamtools</a></span><span class="op">)</span></span></code></pre></div>
<p>Functions from <code>Rsamtools</code> that we will use - in order - are:</p>
<ul>
<li>
<code>BamFile</code>: Reference to the BAM data and its index (<code>.bam.bai</code>)</li>
<li>
<code>ScanBamParam</code>: Sets the <em>parameters</em> for selecting a certain region from the genome using <code>GRanges</code> (i.e., a gene from our BED-data)</li>
<li>
<code>pileup</code>: Actually retrieves the region of interest given the <code>BamFile</code> and parameters supplied.</li>
</ul>
<p><strong>Assignment</strong>:</p>
<ul>
<li>Load the BAM mapping data into a list of data-frames covering all mapped positions of interest</li>
</ul>
<div id="instructions" class="section level4" number="3.1.8.1">
<h4>
<span class="header-section-number">3.1.8.1</span> Instructions<a class="anchor" aria-label="anchor" href="#instructions"><i class="fas fa-link"></i></a>
</h4>
<ol style="list-style-type: decimal">
<li><p>Create a <code>BamFile</code> object by providing both the <code>file</code> and <code>index</code> parameters</p></li>
<li>
<p>Create a <code>ScanBamParam</code> object</p>
<ul>
<li>What this does is defining all the ranges that we want to get from the mapping, in this case the ranges of all exons for a gene</li>
<li>Do this by selecting a single gene from your <code>GRangesList</code> object (using the <code>[["geneName"]]</code> syntax) and store this in an object (it’s type will be a <code>GRanges</code>)</li>
<li>Give this <code>GRanges</code> object to the <code>ScanBamParam</code> function and store this in a variable</li>
</ul>
</li>
<li>
<p>Get the actual mapping data for our region of interest</p>
<ul>
<li>Call the <code>pileup</code> function providing - in order - the objects created at points 1-2. Note that you need to tell <code>pileup</code> what the parameter is, so use <code>pileup(file = ..., scanBamParam = ...)</code>
</li>
<li>The output of the <code>pileup</code> function is a data-frame, store this result</li>
<li>Print the first lines of the data-frame (use the <code>head</code> function)</li>
</ul>
</li>
</ol>
<div class="rmdnote">
<p>The mention of <code>pileup</code> in this assignment means looking at a single genomic position like we’ve seen in IGV. There are tools available to generate a <em>pileup</em> file from a BAM file (file format description <a href="http://samtools.sourceforge.net/pileup.shtml">available
here</a> and
<a href="https://en.wikipedia.org/wiki/Pileup_format">here</a>) containing the following information for <strong>all</strong> mapped positions:</p>
<ul>
<li>the chromosome name (1)</li>
<li>reference position (2),</li>
<li>reference base (3),</li>
<li>number of supporting reads (4),</li>
<li>the match (5), either:
<ul>
<li>a dot for a match in the forward strand or</li>
<li>a comma for a match in the reverse strand</li>
<li>a nucleotide in case of a mismatch (upper case for the forward
strand, lower case for the reverse strand)</li>
<li>insertions/ deletions (defined by a <code>+</code> or <code>-</code> sign followed by
a number defining the size of the insert/ deletion, followed by
the bases that form the insert/ deletion).</li>
</ul>
</li>
<li>the quality [6] (taken from the FASTQ file) can be seen in the last
column, one value for each read</li>
</ul>
<pre><code>  1          2   3    4   5     6
chr1     10004   c    1   ,     [ 
chr1     10005   g    3   ,,.   ?1&gt;</code></pre>
<p>The reason this format is called <em>pileup</em> is because for each <em>position</em>
it will pile (or stack) the data from all mapped reads for that
position. In the first example line above (chromosome 1, position 10004)
there was only one read with a match (the reference is a C as shown in
column 3) in the reverse strand and the second line has three supporting
reads with a match.</p>
<p>The line below is an example where multiple reads (30 in total, as shown
in column 4 and by the lengths of columns 5 and 6) mapped on a single
position. Here on chromosome 1 we see that in column 5 there is
something going on. Read 8 contained a <code>C</code> whereas the reference (and
the other 29 reads) show a <code>T</code> at this position, so this is classified
as a mismatch which will be the subject of further analysis steps.</p>
<pre><code>chr1    16888646    T   30  .......C........,.,.....,,....  WomHHGomooHmHFHHGGFH1GDHHHHGFF</code></pre>
<p>Besides mismatches, we can also have <em>insertions</em> and <em>deletions</em> such
as shown in the example below with a <code>-</code> sign followed by a number and a
number of bases that are missing.</p>
<pre><code>chr1    16888710    a   31  ..,.,..,..,,-2ct,,..,.,,.-2CT,,.,,.,.,, nGFkGUlFF?DFHFGGEnHFFHHGFHG5GGB</code></pre>
</div>
<p>Look at the data that we get for each position and note that we have - at least - two rows of data per position; one on each strand (as we’ve also seen in IGV). If we have <em>more</em> than two rows of data for a single position, it might be a variant which is coincidentally demonstrated in the example data below:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the example Pileup data for the SOD2 gene (do not repeat)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data/sod2_pileup.RData"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">sod2</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<pre><code>##   seqnames       pos strand nucleotide count              which_label
## 1     chr6 160103505      +          C   221 chr6:160103505-160103690
## 2     chr6 160103505      -          C    77 chr6:160103505-160103690
## 3     chr6 160103505      +          T     1 chr6:160103505-160103690
## 4     chr6 160103506      +          T   220 chr6:160103505-160103690
## 5     chr6 160103506      -          T    77 chr6:160103505-160103690</code></pre>
<p>The first position of the SOD2 gene in this case shows three rows; two on the positive strand and one on the negative strand. The <code>count</code> column shows that there is a single read that has a <code>T</code> nucleotide at this position instead of a <code>C</code> that the other 297 reads show. With such a big difference, this can be attributed to a sequencing error.</p>
<p>Note though that what we have now is a <em>summary</em> of the actual pileup compared to the very detailed line we see in the actual Pileup file within Galaxy. This data is also available using <code>RSamtools</code> but we only require this summary.</p>
</div>
</div>
</div>
<div id="assignment-6-pileup-processing" class="section level2" number="3.2">
<h2>
<span class="header-section-number">3.2</span> Assignment 6; Pileup Processing<a class="anchor" aria-label="anchor" href="#assignment-6-pileup-processing"><i class="fas fa-link"></i></a>
</h2>
<p>In this assignment we will get the pileup data for all of our genes into a single object so that we can report on the average coverage of each gene and determine if there are positions with a low coverage that we might need to inspect, more on that later.</p>
<p>Steps that need to be taken:</p>
<ol style="list-style-type: decimal">
<li>Create an empty list (this will hold a separate data-frame for each gene as created in assignment 5)</li>
<li>Iterate over your BED-data (the <code>GRangesList</code> object) similar as we did in assignment 3</li>
<li>Get the pileup data for each gene in the for-loop, by creating a <code>ScanBamParam</code> and executing the <code>pileup</code> function</li>
<li>Add the resulting pileup data-frame to the list, using it’s gene name as identifier (<code>pileup_list[[gene_name]] &lt;- ...</code>)</li>
<li>Check by printing the <code>head</code> again for the same gene as used in assignment 5</li>
</ol>
</div>
<div id="assignment-7-coverage-calculation-and-reporting" class="section level2" number="3.3">
<h2>
<span class="header-section-number">3.3</span> Assignment 7; Coverage calculation and reporting<a class="anchor" aria-label="anchor" href="#assignment-7-coverage-calculation-and-reporting"><i class="fas fa-link"></i></a>
</h2>
<p>Calculating the actual coverage for each position is a little cumbersome as we need to sum the count of all rows for a single position since we don’t - yet - care about mismatches or the strand a read is mapped on.</p>
<p>Instead of performing all kinds of programming steps to check if positions are similar and if so, summing the count values, we can use an R function to do this for us. We don’t expect you to understand the following example besides understanding what it produces. This summation can done by a function called <code>aggregate</code>, defined as “<em>Compute Summary Statistics of Data Subsets</em>”.</p>
<p>Given a column to group on (our <code>pos</code> column) it will perform a function on a different column (our <code>count</code> column containing the coverage. The result of aggregate is a two-column data-frame with the position and the sum of all count values for this position; the total coverage.</p>
<p>We provide the arguments as follows:</p>
<ul>
<li>
<code>x</code>: the <code>count</code> column (we provide it as a list so it gets a name in the resulting data-frame as well)</li>
<li>
<code>by</code>: the <code>pos</code> column the grouping is applied to</li>
<li>
<code>FUN</code>: the function to perform on all grouped rows (in this case, the <code>sum</code> function)</li>
</ul>
<p>Use the code below but check and rename the used variables to suit your data.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coverage</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>count<span class="op">=</span><span class="va">sod2</span><span class="op">$</span><span class="va">count</span><span class="op">)</span>, </span>
<span>                     by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pos<span class="op">=</span><span class="va">sod2</span><span class="op">$</span><span class="va">pos</span><span class="op">)</span>, FUN<span class="op">=</span><span class="va">sum</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">coverage</span><span class="op">)</span></span></code></pre></div>
<pre><code>##         pos count
## 1 160103505   299
## 2 160103506   297
## 3 160103507   297
## 4 160103508   291
## 5 160103509   292
## 6 160103510   290</code></pre>
<p>Your task now is to calculate this per-position coverage for all genes and to calculate and report on - for each gene:</p>
<ul>
<li>the number of bases sequenced for this gene,</li>
<li>the average coverage of the gene and</li>
<li>the number of low-coverage positions (coverage &lt; 30) both in number <strong>and</strong> as the calculated percentage.</li>
</ul>
<p>Given these tasks and your code from previous assignments, you should be able to do this. Store the calculated values (4 values) combined with the gene name in a new data-frame and show it completely in your lab-journal, ordered by the percentage of low-coverage positions, descending.</p>
<p>The following code can be used to create an empty data-frame and add rows to the data. Note that this isn’t done very often, use and forget. The first line of code (the <code>options</code> function) is needed to stop some annoying R behaviour.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Tell R not to complain...</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create empty data-frame, but specify columns and data types</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Name<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>, Course<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>, Grade<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a new row of data, stored as a named list (important)</span></span>
<span><span class="va">new_row</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Name<span class="op">=</span><span class="st">"James"</span>, Course<span class="op">=</span><span class="st">"Math"</span>, Grade<span class="op">=</span><span class="fl">7.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Append data to the data-frame using rbind</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html">rbind</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">new_row</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Or within a single line</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/cbind.html">rbind</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Name<span class="op">=</span><span class="st">"Wendy"</span>, Course<span class="op">=</span><span class="st">"Math"</span>, Grade<span class="op">=</span><span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># print</span></span>
<span><span class="va">df</span></span></code></pre></div>
<pre><code>##    Name Course Grade
## 1 James   Math   7.5
## 2 Wendy   Math   8.0</code></pre>
<div id="hints" class="section level3" number="3.3.1">
<h3>
<span class="header-section-number">3.3.1</span> Hints<a class="anchor" aria-label="anchor" href="#hints"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>As with the other assignments using iteration, create the data-frame <em>outside</em> of the <code>for</code>-loop and perform the <code>rbind</code> <em>within</em> the <code>for</code>-loop.</li>
<li>Take a good look (and print while testing) at <em>what</em> you are iterating over; in this case a <code>list</code> containing <code>data-frames</code>.</li>
<li>You need to re-use the <code>aggregate</code> code but adjust it to make sure it uses the data you get each iteration</li>
<li>Store each calculated value in a variable within the <code>for</code>-loop and check (print) them as mistakes are easily made.</li>
</ul>
</div>
<div id="end-result" class="section level3" number="3.3.2">
<h3>
<span class="header-section-number">3.3.2</span> End Result<a class="anchor" aria-label="anchor" href="#end-result"><i class="fas fa-link"></i></a>
</h3>
<p>Below is an example of data you might get when you have completed this assignment. Note that all values as well as the column names will be different in your case.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load example data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data/statistics.RData"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">statistics</span></span></code></pre></div>
<pre><code>##        length avg_coverage low_coverage low_coverage_perc
## ABCC9    6348        249.2            0               0.0
## ACTC1    1375        192.4           57               4.1
## ACTN2    3527        184.5            0               0.0
## ANKRD1   1322        232.4            0               0.0
## BAG3     1892        207.7            0               0.0
## CALR3    1511        242.5            0               0.0
## CAV3      536        196.0            0               0.0
## CRYAB     650        156.8            0               0.0
## CSRP3     785        230.6            0               0.0
## DES      1774        122.9          258              14.5
## DMD     14643        248.7            0               0.0
## DSC2     3424        237.9          109               3.2
## DSG2     3959        239.1           86               2.2
## DSP      9577        237.4            4               0.0
## DTNA     3133        238.0            0               0.0
## EMD      1006        169.9            0               0.0
## EYA4     2683        251.9            0               0.0
## GATAD1   1010        183.3          210              20.8
## GLA      1570        237.6            0               0.0
## JPH2     2292         88.7          699              30.5
## JUP      2758         78.2          276              10.0
## LAMA4    7193        236.0            0               0.0
## LAMP2    1957        240.1            0               0.0
## LDB3     3148        144.0           78               2.5
## LMNA     2496         81.6          118               4.7
## MYBPC3   5195        121.8          503               9.7
## MYH6     7301        200.1           32               0.4
## MYH7     7329        205.0            0               0.0
## MYL2      781        211.4            1               0.1
## MYL3      828        164.4            0               0.0
## MYOZ1    1100        230.5            0               0.0
## MYOZ2     995        252.1            0               0.0
## MYPN     4723        243.7            0               0.0
## NEXN     2511        247.7            0               0.0
## PKP2     3206        207.9          263               8.2
## PLN       199        233.8            0               0.0
## PRKAG2   2350        183.2          349              14.9
## PSEN1    1804        241.4            0               0.0
## PSEN2    1747        150.2           56               3.2
## RBM20    4243        215.7          230               5.4
## RYR2    19104        246.3           88               0.5
## SCN5A    6633        162.7          275               4.1
## SGCD     1193        232.9            0               0.0
## SOD2      869        184.4            6               0.7
## TAZ      1400        168.5            0               0.0
## TBX20    1664        193.4          167              10.0
## TCAP      584         80.6            0               0.0
## TMEM43   1683        179.5           52               3.1
## TNNC1     726        175.0            0               0.0
## TNNI3     953        105.2            0               0.0
## TNNT2    1458        200.3           24               1.6
## TPM1     1941        183.4          326              16.8
## TTN    123059        250.0            0               0.0
## TXNRD2   2241        132.8          116               5.2
## VCL      4285        210.5           89               2.1</code></pre>
</div>
</div>
<div id="finding-variants-using-lofreq" class="section level2" number="3.4">
<h2>
<span class="header-section-number">3.4</span> Finding Variants using <code>LoFreq</code><a class="anchor" aria-label="anchor" href="#finding-variants-using-lofreq"><i class="fas fa-link"></i></a>
</h2>
<p>Most likely you’ve already seen how a true variant (not a single or few mismatches) looks when we looked at the data in the IGV-browser. For such a variant you see a number of reads having a different base at that positions compared to the reference genome. As we’ve mentioned before, we are interested in all these variants in our patient data for the all the genes in our genepanel. The previous <em>visualize-your-data</em> assignment did not ask to find all these variants using the IGV-browser because in this section we are going to use a program to do this for us.</p>
<p>The tool that we will use is the <a href="https://csb5.github.io/lofreq/">LoFreq</a> tool that scans the BAM file for variants. This tool has a few settings that, combined, defines when a position is called a variant. You could do this in a naive way and just report for each position if there is a change. But this will result in many false positive variants (can you explain this?). We need a more statistical approach to filter out low quality variants and that’s why the tool has settings to for instance set the minimum amount of reads (coverage) at a position to consider looking for variations. Also the variants itself should be supported by a minimum number of reads and the base quality of that position should not be too low.</p>
<p><strong>Instructions</strong>:</p>
<p>Run the <code>Call variants with LoFreq</code> tool using its default settings. Select the output BAM file from the Mark Duplicate tool and use the available <code>GRCh38</code> reference genome. Feel free to explore the other options but leave the <code>Call variants across</code> settings on <code>Whole reference</code> (this setting allows using a BED file for only selecting variants of interest which is basically the following assignment).</p>
<div id="vcf-file-filtering" class="section level3" number="3.4.1">
<h3>
<span class="header-section-number">3.4.1</span> VCF File Filtering<a class="anchor" aria-label="anchor" href="#vcf-file-filtering"><i class="fas fa-link"></i></a>
</h3>
<p>The result of the LoFreq tool is a single new file in your history in the <a href="http://www.internationalgenome.org/wiki/Analysis/vcf4.0/"><strong>vcf</strong></a> file format where each line describes a single variant. In Galaxy you can then directly see how many variants you have; often well over 1000 in total. Note the 17 comment-lines at the top of the file.</p>
<p>When looking at this file in more detail it is fairly easy to see variants in places we are not interested in. As you’ve seen in IGV, many regions have been sequenced outside of our genes of interest, or even very far from a gene at all. LoFreq also checked those regions for variants and this assignment asks to filter the list of variants only keeping those within exon boundaries of our genes of interest. Then, another filtering step is filtering on actual variants. We do this by looking at the <a href="https://en.wikipedia.org/wiki/Allele_frequency">allele frequency</a> value included in the VCF file. In our case, this value describes the percentage of reads having the <strong>variant</strong> base.</p>
</div>
<div id="assignment-8-vcf-file-processing" class="section level3" number="3.4.2">
<h3>
<span class="header-section-number">3.4.2</span> Assignment 8; VCF File Processing<a class="anchor" aria-label="anchor" href="#assignment-8-vcf-file-processing"><i class="fas fa-link"></i></a>
</h3>
<p>Please briefly read the linked wikipedia page to understand why this value is of importance. As we are working with patient data, we use the protocol as described by the UMCG that states that variants with a minimum frequency of <strong>30%</strong> are retained. This means we will filter out any variants with a <em>lower</em> value. Note that LoFreq stores this value as a fraction so we filter for values <span class="math inline">\(&gt;= 0.3\)</span>.</p>
<p>There are once again step-by-step instructions for completing this assignment. It is however possible to do it without these instructions as we partly repeat steps we’ve taken in the previous assignments.</p>
<ol style="list-style-type: decimal">
<li>Read in the data into a data-frame using the <code>read.delim</code> function
<ul>
<li>Make sure the data has a proper header (line 18 in the data)</li>
<li>Provide the <code>stringsAsFactors = FALSE</code> argument, otherwise the next part won’t work (we cannot split an R <code>factor</code>)</li>
</ul>
</li>
</ol>
<p>Now that we have the data in a data-frame, inspect that everything is loaded correctly. The first thing that we’ll do now is get the frequency value for each variant. Read the comment lines in the VCF file to see how this value is stored. You’ll see that the columns themselves contain more fields, separated by a semicolon (<code>;</code>) which we can use to <em>split</em> the data to get to the value we want.</p>
<ol start="2" style="list-style-type: decimal">
<li>Split the column containing the frequency value using the <code>strsplit</code> function</li>
</ol>
<p>The output of this function is a list in which each item is a vector with the separate items resulting from the split (inspect this object in RStudio). To get the frequency value from this list, here is some R magic that converts the result from <code>strsplit</code> into a matrix (found on <a href="https://stackoverflow.com/questions/20428742/select-first-element-of-nested-list">Stackoverflow</a>):</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">bed_splitted</span><span class="op">)</span>, n<span class="op">=</span><span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<pre><code>##           chromosome    begin      end  gene
## ABCC9.814         12 21953958 21954135 ABCC9
## ABCC9.815         12 21958088 21958265 ABCC9
## ABCC9.816         12 21958912 21959014 ABCC9
## ABCC9.817         12 21960260 21960433 ABCC9
## ABCC9.818         12 21962766 21962909 ABCC9
## ABCC9.819         12 21964963 21965111 ABCC9
## ABCC9.820         12 21967558 21967676 ABCC9
## ABCC9.821         12 21968677 21968847 ABCC9
## ABCC9.822         12 21970101 21970261 ABCC9
## ABCC9.823         12 21971064 21971205 ABCC9
## ABCC9.824         12 21981872 21982014 ABCC9
## ABCC9.825         12 21990992 21991124 ABCC9
## ABCC9.826         12 21995228 21995425 ABCC9
## ABCC9.827         12 21997397 21997506 ABCC9
## ABCC9.828         12 21997681 21997869 ABCC9
## ABCC9.829         12 21998517 21998786 ABCC9
## ABCC9.830         12 22001064 22001200 ABCC9
## ABCC9.831         12 22005011 22005176 ABCC9
## ABCC9.832         12 22005282 22005459 ABCC9
## ABCC9.833         12 22012500 22012620 ABCC9</code></pre>
<p>What it does is <code>rbind</code>s all vectors into a matrix. Again, inspect this object to see where the actual value is located that you want (use the <code>View</code> function in RStudio or click on the name in the <code>Environment</code> tab).</p>
<ol start="3" style="list-style-type: decimal">
<li>Write a so called one-liner (multiple statements in a single line of code) that:
<ul>
<li>removes the <code>AF=</code> part using the <code>gsub</code> function</li>
<li>converts the data type of this column to <code>numeric</code>
</li>
<li>saves only this column into a new variable</li>
</ul>
</li>
</ol>
<p>We now have the frequency value available for filtering and we’ll do that by adding it to the <code>GRanges</code> object we create next:</p>
<ol start="4" style="list-style-type: decimal">
<li>Create a <code>GRanges</code> object as we’ve done for assignment 3 by simply creating an <code>IRanges</code> object where the <code>start</code> and <code>end</code> parameters both get the variant position column (<code>POS</code> column). Also provide the <code>seqnames</code> parameter to <code>GRanges</code> which get the contents of the chromosome column.</li>
</ol>
<p><code>GRanges</code> objects can contain other data as well, called <em>associated metadata</em>. Using the <code>mcols</code> function we can see existing or assign data to each variant. Adding this as a data-frame allows us to set a name for this column as demonstrated below with an example from the previous chapter:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Select and show data for a single gene (note that it specifies "... and 0 metadata columns")</span></span>
<span><span class="co"># ('granges' object is used from assignment 3)</span></span>
<span><span class="va">granges</span></span></code></pre></div>
<pre><code>## GRanges object with 5 ranges and 0 metadata columns:
##        seqnames              ranges strand
##           &lt;Rle&gt;           &lt;IRanges&gt;  &lt;Rle&gt;
##   SOD2     chr6 160103505-160103690      *
##   SOD2     chr6 160105866-160106085      *
##   SOD2     chr6 160109138-160109294      *
##   SOD2     chr6 160113673-160113915      *
##   SOD2     chr6 160114157-160114219      *
##   -------
##   seqinfo: 1 sequence from an unspecified genome; no seqlengths</code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate some random values for 'allele frequency'</span></span>
<span><span class="va">allele_frequency</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">5</span>, mean <span class="op">=</span> <span class="fl">0.45</span>, sd <span class="op">=</span> <span class="fl">0.35</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bind this data to the 'GRanges' object</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html">mcols</a></span><span class="op">(</span><span class="va">granges</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/DataFrame-class.html">DataFrame</a></span><span class="op">(</span>AF<span class="op">=</span><span class="va">allele_frequency</span><span class="op">)</span></span>
<span></span>
<span><span class="va">granges</span></span></code></pre></div>
<pre><code>## GRanges object with 5 ranges and 1 metadata column:
##        seqnames              ranges strand |        AF
##           &lt;Rle&gt;           &lt;IRanges&gt;  &lt;Rle&gt; | &lt;numeric&gt;
##   SOD2     chr6 160103505-160103690      * |       0.5
##   SOD2     chr6 160105866-160106085      * |       0.6
##   SOD2     chr6 160109138-160109294      * |       0.1
##   SOD2     chr6 160113673-160113915      * |       0.7
##   SOD2     chr6 160114157-160114219      * |       0.8
##   -------
##   seqinfo: 1 sequence from an unspecified genome; no seqlengths</code></pre>
<p>Use the example above to associate the frequency value with the created <code>GRanges</code> object. Now that we have both the BED-data (in a <code>GRangesList</code> object) and the VCF data in a <code>GRanges</code> object, we can</p>
<ol start="5" style="list-style-type: decimal">
<li>Get all variants that fall within an exon
<ul>
<li>Use the <code>findOverlaps</code> function and store its output</li>
<li>Convert the output to a data-frame</li>
</ul>
</li>
</ol>
<p>The result from <code>findOverlaps</code> contains two columns of which we are interested in the <code>subjectHits</code> column; the rows from the VCF data that lie within an exon. You can use this column to subset the <code>GRanges</code> VCF object with. Note that the <code>queryHits</code> column describes not the exons but the genes; meaning a queryHit value of <code>1</code> refers to a hit within any of the <code>ABCC9</code> gene exons.</p>
<ol start="6" style="list-style-type: decimal">
<li>Filter the <strong>remaining</strong> variants based on their frequency, using a minimum of <strong>30%</strong>
<ul>
<li>Instead of removing rows or creating another subset, make sure you know which rows are to be kept after both filtering steps as we are going to reconstruct the original VCF file (we need it in Galaxy)</li>
<li>Manually sample a few rows to see if they do fall within an exon and have a frequency &gt; 30%</li>
</ul>
</li>
<li>Now that you have all the row numbers of variants that we want to keep, you need to think of a way to re-construct the VCF file and save it to disk.
<ul>
<li>Hint: read in the VCF file again for subsetting using the <code>readLines</code> function</li>
<li>Note: do not forget to include the 24 header lines!</li>
</ul>
</li>
<li>Upload the new VCF file into Galaxy as we’ll use it in the next chapter.</li>
</ol>
</div>
<div id="assignment-9-variant-visualization" class="section level3" number="3.4.3">
<h3>
<span class="header-section-number">3.4.3</span> Assignment 9; Variant Visualization<a class="anchor" aria-label="anchor" href="#assignment-9-variant-visualization"><i class="fas fa-link"></i></a>
</h3>
<p>We will create two simple visualizations:</p>
<ul>
<li>Visualize the <strong>allele frequency</strong> for all remaining variants using the <code>hist</code> function. Remember that you can use the <code>mcols</code> function to get a metadata column or use the <code>$</code>-sign and the name of the column. Pass the argument <code>breaks=20</code> to <code>hist</code> and answer the following question in your lab-journal:
<ul>
<li>Can you explain the two peaks that you see in your histogram (around 50% and 100%)?</li>
</ul>
</li>
<li>Visualize the amount of variants per gene. A simple solution for getting the numbers is to use the <code>table</code> function on the <code>queryHits</code> column (output of <code>findOverlaps</code>). Convert it to a data frame and then use the gene indices to get the actual gene names. Now you should have a combination of gene and number of variants. Create a barplot with this data as in the previous chapter and use <code>cex.names=0.7</code> to scale the gene names to make them all visible.</li>
</ul>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="read-mapping.html"><span class="header-section-number">2</span> Read Mapping</a></div>
<div class="next"><a href="variant-annotation.html"><span class="header-section-number">4</span> Variant Annotation</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#analysis-of-cardiopanel-variants"><span class="header-section-number">3</span> Analysis of Cardiopanel Variants</a></li>
<li>
<a class="nav-link" href="#assignment-week-3"><span class="header-section-number">3.1</span> Assignment week 3</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#programming-assignments-coverage-overview-for-cardiopanel-genes"><span class="header-section-number">3.1.1</span> Programming Assignments; Coverage Overview for Cardiopanel Genes</a></li>
<li><a class="nav-link" href="#assignment-instructions"><span class="header-section-number">3.1.2</span> Assignment Instructions</a></li>
<li><a class="nav-link" href="#assignment-1-loading-the-bed-data"><span class="header-section-number">3.1.3</span> Assignment 1; Loading the BED-data</a></li>
<li><a class="nav-link" href="#assignment-2-bed-visualization"><span class="header-section-number">3.1.4</span> Assignment 2; BED-visualization</a></li>
<li><a class="nav-link" href="#assignment-3-bioconductor"><span class="header-section-number">3.1.5</span> Assignment 3; Bioconductor</a></li>
<li><a class="nav-link" href="#assignment-4-gene-lengths"><span class="header-section-number">3.1.6</span> Assignment 4; Gene Lengths</a></li>
<li><a class="nav-link" href="#assignment-5-loading-the-mapped-reads"><span class="header-section-number">3.1.7</span> Assignment 5; Loading the Mapped Reads</a></li>
<li><a class="nav-link" href="#rsamtools"><span class="header-section-number">3.1.8</span> Rsamtools</a></li>
</ul>
</li>
<li><a class="nav-link" href="#assignment-6-pileup-processing"><span class="header-section-number">3.2</span> Assignment 6; Pileup Processing</a></li>
<li>
<a class="nav-link" href="#assignment-7-coverage-calculation-and-reporting"><span class="header-section-number">3.3</span> Assignment 7; Coverage calculation and reporting</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#hints"><span class="header-section-number">3.3.1</span> Hints</a></li>
<li><a class="nav-link" href="#end-result"><span class="header-section-number">3.3.2</span> End Result</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#finding-variants-using-lofreq"><span class="header-section-number">3.4</span> Finding Variants using LoFreq</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#vcf-file-filtering"><span class="header-section-number">3.4.1</span> VCF File Filtering</a></li>
<li><a class="nav-link" href="#assignment-8-vcf-file-processing"><span class="header-section-number">3.4.2</span> Assignment 8; VCF File Processing</a></li>
<li><a class="nav-link" href="#assignment-9-variant-visualization"><span class="header-section-number">3.4.3</span> Assignment 9; Variant Visualization</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/rwedema/NGS-Genetics//blob/master/03-week3-pileup.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/rwedema/NGS-Genetics//edit/master/03-week3-pileup.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Case background information and exercises</strong>" was written by Marcel Kempenaar and Ronald Wedema. It was last built on 2023-10-07.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
